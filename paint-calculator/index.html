<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ å¡—æ–™ç¡¬åŒ–å‰¤è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 900px; margin-top: 20px; }
        .input-section, .output-section { padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-section { background-color: #ffffff; border: 1px solid #dee2e6; }
        .output-section { background-color: #e9ecef; border: 1px solid #ced4da; }
        .liquid-row { margin-bottom: 15px; padding: 10px; border: 1px dashed #ced4da; border-radius: 4px; }
        .result-value { font-size: 1.25rem; font-weight: bold; color: #007bff; }
        .unit-toggle { margin-bottom: 15px; }
        .form-label { font-weight: 600; }
        .calculation-mode { font-size: 1.2rem; font-weight: bold; color: #28a745; margin-top: 10px; }
        .density-toggle { cursor: pointer; color: #007bff; text-decoration: underline; }
        .density-inputs { display: none; margin-top: 10px; padding: 10px; background-color: #f1f1f1; border-radius: 4px;}
        /* åŸºæº–å€¤å…¥åŠ›æ¬„ã‚’å¼·èª¿ */
        #baseValueInput { font-size: 1.25rem; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-4">ğŸ¨ å¡—æ–™ç¡¬åŒ–å‰¤ãƒ»å¸Œé‡ˆæ¶²è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>

    <div class="input-section">
        <h3 class="mb-3">1. åŸºæœ¬æƒ…å ±</h3>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="ratioUnit" class="form-label">æ··åˆæ¯”ã®åŸºæº–</label>
                <select id="ratioUnit" class="form-select" onchange="calculate()">
                    <option value="weight">é‡é‡æ¯” (kg/g)</option>
                    <option value="volume">ä½“ç©æ¯” (L/mL)</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="surfaceAmount" class="form-label">æ¨™æº–å¡—å¸ƒé‡ (C)</label>
                <div class="input-group">
                    <input type="number" id="surfaceAmount" class="form-control" value="0.2" min="0" oninput="calculate()">
                    <select id="surfaceUnit" class="form-select" onchange="calculate()">
                        <option value="kg/m2">kg/mÂ²</option>
                        <option value="L/m2">L/mÂ²</option>
                    </select>
                </div>
                <small class="text-muted">ï¼ˆæ··åˆæ¶² $\text{m}^2$ ã‚ãŸã‚Šã®æ‰€è¦é‡ï¼‰</small>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="dilutionRate" class="form-label">å¸Œé‡ˆç‡ (D)</label>
                <div class="input-group">
                    <input type="number" id="dilutionRate" class="form-control" value="10" min="0" oninput="calculate()">
                    <span class="input-group-text">%</span>
                </div>
            </div>
            <div class="col-md-6">
                <label for="lossRate" class="form-label">ä½œæ¥­ãƒ­ã‚¹ç‡ (L)</label>
                <div class="input-group">
                    <input type="number" id="lossRate" class="form-control" value="5" min="0" oninput="calculate()">
                    <span class="input-group-text">%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="input-section">
        <h3 class="mb-3">2. æ¶²ä½“æƒ…å ±ã¨æ¯”ç‡</h3>
        
        <div id="liquidsContainer">
            </div>

        <button class="btn btn-sm btn-outline-success me-2" onclick="addLiquid()">+ æ¶²ä½“ã‚’è¿½åŠ </button>
        <button class="btn btn-sm btn-outline-danger" onclick="removeLiquid()">- æ¶²ä½“ã‚’å‰Šé™¤</button>

        <p class="density-toggle mt-3" onclick="toggleDensityInputs()">
            é‡é‡ãƒ»ä½“ç©ã®ç›¸äº’å¤‰æ›ãŒå¿…è¦ãªå ´åˆã¯ã“ã¡ã‚‰ã‚’ã‚¿ãƒƒãƒ—
        </p>

        <div id="densityInputs" class="density-inputs">
            <small class="text-danger d-block mb-2">â€» æ··åˆæ¯”ã®åŸºæº–ã¨ç•°ãªã‚‹å˜ä½ã§çµæœã‚’è¦‹ãŸã„å ´åˆã®ã¿å…¥åŠ›</small>
            <div id="liquidDensityContainer">
                </div>
        </div>
    </div>

    <div class="input-section bg-light">
        <h3 class="mb-3">3. è¨ˆç®—åŸºæº–ï¼ˆã©ã‚Œã‹ä¸€ã¤ã‚’é¸æŠï¼‰</h3>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="baseMode" class="form-label">è¨ˆç®—åŸºæº–</label>
                <select id="baseMode" class="form-select" onchange="updateBaseValueInput(); calculate()">
                    </select>
            </div>
            <div class="col-md-6">
                <label for="baseValueInput" class="form-label">åŸºæº–å€¤</label>
                <div class="input-group">
                    <input type="number" id="baseValueInput" class="form-control" value="10" min="0" oninput="calculate()">
                    <span class="input-group-text" id="baseValueUnit">mÂ²</span>
                </div>
            </div>
        </div>

        <p class="calculation-mode">ç¾åœ¨ã®è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰: <span id="calculationMode">å¡—è£…é¢ç© (A) åŸºæº–</span></p>
    </div>

    <div class="output-section">
        <h3 class="mb-3">4. è¨ˆç®—çµæœï¼ˆå¿…è¦é‡ï¼‰</h3>
        
        <div class="unit-toggle text-end">
            <button class="btn btn-sm btn-primary" id="toggleUnitBtn" onclick="toggleUnit()">å˜ä½åˆ‡ã‚Šæ›¿ãˆ (kg â†” g)</button>
            <small class="d-block text-muted">â€» è¡¨ç¤ºå˜ä½ã® $\text{kg/g}$ ã¨ $\text{L/mL}$ ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™</small>
        </div>

        <div class="row" id="resultsContainer">
            </div>

        <hr>
        
        <div class="row">
            <div class="col-md-6 mb-2">
                <p class="mb-0">æ··åˆæ¶²åˆè¨ˆ (V'mix)</p>
                <p class="result-value" id="result_V_mix">0.00 kg</p>
            </div>
            <div class="col-md-6 mb-2">
                <p class="mb-0">å¸Œé‡ˆæ¶²æ‰€è¦é‡ (V'thinner)</p>
                <p class="result-value" id="result_V_thinner">0.00 kg</p>
            </div>
            <div class="col-md-6 mb-2">
                <p class="mb-0 text-success">å¸Œé‡ˆæ¶²å…¥ã‚Šåˆè¨ˆ (V'total)</p>
                <p class="result-value text-success" id="result_V_total">0.00 kg</p>
            </div>
            <div class="col-md-6 mb-2">
                <p class="mb-0 text-danger">å¡—è£…å¯èƒ½é¢ç© (A) â€»ãƒ­ã‚¹å«ã¾ãš</p>
                <p class="result-value text-danger" id="result_A">0.00 mÂ²</p>
            </div>
        </div>

    </div>
</div>

<script>
    let liquidCount = 0;
    let currentUnit = 'kg'; // kg or g, L or mL
    let baseUnitType = 'weight'; // weight or volume

    document.addEventListener('DOMContentLoaded', () => {
        addLiquid('ä¸»æ¶²', 4); // åˆæœŸå€¤ï¼šä¸»æ¶² 4
        addLiquid('ç¡¬åŒ–å‰¤', 1); // åˆæœŸå€¤ï¼šç¡¬åŒ–å‰¤ 1
        calculate();
    });

    /**
     * å¯†åº¦å…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     */
    function toggleDensityInputs() {
        const densityDiv = document.getElementById('densityInputs');
        if (densityDiv.style.display === 'none' || densityDiv.style.display === '') {
            densityDiv.style.display = 'block';
        } else {
            densityDiv.style.display = 'none';
        }
    }

    /**
     * æ¶²ä½“å…¥åŠ›è¡Œã‚’è¿½åŠ ã™ã‚‹
     * @param {string} defaultName - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¶²å
     * @param {number} defaultRatio - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¯”ç‡
     */
    function addLiquid(defaultName, defaultRatio = 0) {
        liquidCount++;
        const liquidId = `L${liquidCount}`;
        const name = defaultName + (defaultName.includes('æ·»åŠ å‰¤') ? (liquidCount - 2) : '');
        
        // === 1. åŸºæœ¬æƒ…å ±ã¨æ¯”ç‡ ===
        const container = document.getElementById('liquidsContainer');
        const newRow = document.createElement('div');
        newRow.className = 'row liquid-row';
        newRow.id = liquidId;
        
        newRow.innerHTML = `
            <div class="col-lg-6 col-md-6 mb-2">
                <label for="${liquidId}_name" class="form-label">æ¶²å</label>
                <input type="text" id="${liquidId}_name" class="form-control" value="${name}" oninput="updateBaseModeOptions(); updateLiquidResultLabels()">
            </div>
            <div class="col-lg-6 col-md-6 mb-2">
                <label for="${liquidId}_ratio" class="form-label">æ¯”ç‡ (R)</label>
                <input type="number" id="${liquidId}_ratio" class="form-control" value="${defaultRatio}" min="0" oninput="calculate()">
            </div>
        `;
        container.appendChild(newRow);
        
        // === 2. å¯†åº¦å…¥åŠ›æ¬„ã®è¿½åŠ  ===
        const densityContainer = document.getElementById('liquidDensityContainer');
        const densityRow = document.createElement('div');
        densityRow.className = 'row mb-2';
        densityRow.id = `${liquidId}_densityRow`;
        densityRow.innerHTML = `
            <div class="col-6">
                <label for="${liquidId}_density" class="form-label">${name} å¯†åº¦</label>
                <div class="input-group">
                    <input type="number" id="${liquidId}_density" class="form-control" value="1.0" min="0.01" oninput="calculate()">
                    <span class="input-group-text">kg/L</span>
                </div>
            </div>
        `;
        densityContainer.appendChild(densityRow);
        
        // === 3. çµæœè¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠã«ã‚‚è¦ç´ ã‚’è¿½åŠ  ===
        const resultsContainer = document.getElementById('resultsContainer');
        const resultDiv = document.createElement('div');
        resultDiv.className = 'col-md-6 mb-2';
        resultDiv.id = `result_${liquidId}_div`;
        resultDiv.innerHTML = `
            <p class="mb-0" id="result_${liquidId}_label">${name} æ‰€è¦é‡</p>
            <p class="result-value" id="result_${liquidId}">0.00 ${currentUnit}</p>
        `;
        resultsContainer.appendChild(resultDiv);

        updateBaseModeOptions();
    }

    /**
     * æ¶²ä½“å…¥åŠ›è¡Œã‚’å‰Šé™¤ã™ã‚‹
     */
    function removeLiquid() {
        if (liquidCount > 2) {
            const liquidId = `L${liquidCount}`;
            document.getElementById(liquidId).remove();
            document.getElementById(`result_${liquidId}_div`).remove();
            document.getElementById(`${liquidId}_densityRow`).remove();
            
            liquidCount--;
            updateBaseModeOptions();
            calculate();
        } else {
            alert('ä¸»æ¶²ã€ç¡¬åŒ–å‰¤ã®2æ¶²ã¯å¿…é ˆã§ã™ã€‚');
        }
    }

    /**
     * è¨ˆç®—åŸºæº–é¸æŠè‚¢ (baseMode) ã‚’å‹•çš„ã«æ›´æ–°ã™ã‚‹
     */
    function updateBaseModeOptions() {
        const select = document.getElementById('baseMode');
        let currentMode = select.value;
        select.innerHTML = ''; // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢

        // å¡—è£…é¢ç© (A)
        select.add(new Option('å¡—è£…é¢ç© (A)', 'area', true));

        // æ··åˆæ¶²é‡ (V_mix)
        select.add(new Option('ä½œæˆé‡ (V_mix)', 'V_mix'));

        // å€‹åˆ¥æ¶²ä½“ã®é‡ (Vi)
        for (let i = 1; i <= liquidCount; i++) {
            const liquidId = `L${i}`;
            const name = document.getElementById(`${liquidId}_name`).value;
            select.add(new Option(`${name}é‡ (V${i})`, liquidId));
        }

        // ä»¥å‰ã®é¸æŠè‚¢ã‚’ä¿æŒ
        if (document.querySelector(`#baseMode option[value="${currentMode}"]`)) {
            select.value = currentMode;
        } else {
            select.value = 'area';
        }
        updateBaseValueInput();
    }

    /**
     * åŸºæº–å€¤å…¥åŠ›æ¬„ã®å˜ä½ã¨ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹
     */
    function updateBaseValueInput() {
        const mode = document.getElementById('baseMode').value;
        const unitEl = document.getElementById('baseValueUnit');
        const unitType = document.getElementById('ratioUnit').value === 'weight' ? 'kg' : 'L';
        
        let label = '';
        let unit = '';

        if (mode === 'area') {
            label = 'å¡—è£…é¢ç©';
            unit = 'mÂ²';
        } else if (mode === 'V_mix') {
            label = 'ä½œæˆé‡ (æ··åˆæ¶²åˆè¨ˆ)';
            unit = unitType;
        } else {
            const liquidName = document.getElementById(`${mode}_name`).value;
            label = `${liquidName}é‡`;
            unit = unitType;
        }

        document.getElementById('baseValueInput').placeholder = label;
        unitEl.textContent = unit;
        document.querySelector('label[for="baseValueInput"]').textContent = `åŸºæº–å€¤ (${label})`;
    }

    /**
     * å˜ä½ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ (kg <-> g, L <-> mL)
     */
    function toggleUnit() {
        baseUnitType = document.getElementById('ratioUnit').value;
        const isWeight = baseUnitType === 'weight';

        if (isWeight) {
            currentUnit = currentUnit === 'kg' ? 'g' : 'kg';
        } else {
            currentUnit = currentUnit === 'L' ? 'mL' : 'L';
        }
        
        calculate();
    }

    /**
     * ãƒ¡ã‚¤ãƒ³è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
     */
    function calculate() {
        const liquids = [];
        let totalRatio = 0;
        
        const baseMode = document.getElementById('baseMode').value;
        const baseValue = parseFloat(document.getElementById('baseValueInput').value) || 0;

        const dilutionRate = parseFloat(document.getElementById('dilutionRate').value) / 100 || 0;
        const lossRate = parseFloat(document.getElementById('lossRate').value) / 100 || 0;
        const surfaceAmount = parseFloat(document.getElementById('surfaceAmount').value) || 0;
        const surfaceUnitIsWeight = document.getElementById('surfaceUnit').value === 'kg/m2';
        baseUnitType = document.getElementById('ratioUnit').value;

        // 1. ãƒ‡ãƒ¼ã‚¿åé›†ã¨åˆè¨ˆæ¯”ç‡ã®è¨ˆç®—
        for (let i = 1; i <= liquidCount; i++) {
            const liquidId = `L${i}`;
            const ratio = parseFloat(document.getElementById(`${liquidId}_ratio`).value) || 0;
            const density = parseFloat(document.getElementById(`${liquidId}_density`).value) || 1.0;
            const name = document.getElementById(`${liquidId}_name`).value;
            
            liquids.push({ id: liquidId, name: name, ratio, density });
            totalRatio += ratio;
        }
        
        // 2. è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã¨æ··åˆæ¶²é‡ (V_mix) ã®æ±ºå®š
        let V_mix = 0;
        let modeName = '';

        if (totalRatio === 0) {
            modeName = 'âš ï¸ æ¯”ç‡ã®åˆè¨ˆãŒ0ã§ã™';
        } else if (baseMode === 'area') {
            // å¡—è£…é¢ç©åŸºæº–
            V_mix = baseValue * surfaceAmount;
            modeName = `å¡—è£…é¢ç© (${baseValue} mÂ²) åŸºæº–`;
        } else if (baseMode === 'V_mix') {
            // ä½œæˆé‡åŸºæº–
            V_mix = baseValue;
            modeName = `ä½œæˆé‡ (${baseValue} ${baseUnitType === 'weight' ? 'kg' : 'L'}) åŸºæº–`;
        } else {
            // å€‹åˆ¥æ¶²ä½“é‡ (Vi) åŸºæº–
            const liquid = liquids.find(l => l.id === baseMode);
            if (liquid && liquid.ratio > 0) {
                V_mix = baseValue * (totalRatio / liquid.ratio);
                modeName = `${liquid.name} (${baseValue} ${baseUnitType === 'weight' ? 'kg' : 'L'}) åŸºæº–`;
            } else {
                modeName = 'âš ï¸ åŸºæº–æ¶²ä½“ã®æ¯”ç‡ãŒ0ã§ã™';
            }
        }
        
        document.getElementById('calculationMode').textContent = modeName;

        // 3. å€‹åˆ¥æ¶²ä½“é‡ã®è¨ˆç®—
        liquids.forEach(liquid => {
            liquid.V_i = V_mix * (liquid.ratio / totalRatio);
        });

        // 4. å¸Œé‡ˆæ¶²é‡ã¨åˆè¨ˆé‡ã®è¨ˆç®—
        const V_thinner = V_mix * dilutionRate;
        const V_total = V_mix + V_thinner;
        
        // å¡—è£…å¯èƒ½é¢ç© (V_mixã‚’åŸºæº–ã¨ã™ã‚‹ãŸã‚ãƒ­ã‚¹ã¯å«ã‚ãªã„)
        let A_calculated = 0;
        if (surfaceAmount > 0) {
            // æ··åˆæ¶²é‡ (V_mix) ã¨å¡—é¢æ•£å¸ƒé‡ (C) ã®å˜ä½ã‚’åˆã‚ã›ã‚‹å¿…è¦ã‚ã‚Š
            let V_mix_normalized = V_mix; // V_mixã¯æ¯”ç‡ã®åŸºæº–å˜ä½ï¼ˆkg or Lï¼‰

            // å¡—é¢æ•£å¸ƒé‡ãŒåŸºæº–å˜ä½ã¨ç•°ãªã‚‹å ´åˆã¯å¯†åº¦ã§å¤‰æ›ãŒå¿…è¦
            if (baseUnitType === 'weight' && surfaceUnitIsWeight === false) { // V_mix: kg, C: L/m2ã®å ´åˆ
                const avgDensity = liquids.reduce((sum, l) => sum + (l.V_i * l.density), 0) / V_mix;
                V_mix_normalized = V_mix / avgDensity; // kg -> Lã«å¤‰æ›
            } else if (baseUnitType === 'volume' && surfaceUnitIsWeight === true) { // V_mix: L, C: kg/m2ã®å ´åˆ
                const avgDensity = liquids.reduce((sum, l) => sum + (l.V_i * l.density), 0) / V_mix;
                V_mix_normalized = V_mix * avgDensity; // L -> kgã«å¤‰æ›
            }
            A_calculated = V_mix_normalized / surfaceAmount;
        }

        // 5. çµæœè¡¨ç¤ºï¼ˆå˜ä½å¤‰æ›ã¨ãƒ­ã‚¹ç‡é©ç”¨ï¼‰
        const isConvertKgToG = currentUnit === 'g';
        const isConvertLToML = currentUnit === 'mL';
        const unitLabel = currentUnit;
        const factor = isConvertKgToG || isConvertLToML ? 1000 : 1;
        const isWeight = currentUnit === 'kg' || currentUnit === 'g';

        document.getElementById('toggleUnitBtn').textContent = `${baseUnitType === 'weight' ? 'é‡é‡' : 'ä½“ç©'}å˜ä½åˆ‡ã‚Šæ›¿ãˆ (${currentUnit} â†” ${isConvertKgToG ? 'kg' : (isConvertLToML ? 'L' : (isWeight ? 'g' : 'mL'))})`;


        // å€‹åˆ¥æ¶²ä½“ã®è¡¨ç¤º
        liquids.forEach(liquid => {
            let V_i_base = liquid.V_i;
            
            // è¡¨ç¤ºå˜ä½ã«åˆã‚ã›ã‚‹ãŸã‚ã®å¤‰æ›ï¼ˆé‡é‡â†”ä½“ç©ï¼‰
            if (baseUnitType === 'weight' && !isWeight) { // è¨ˆç®—åŸºæº–ãŒé‡é‡(kg)ã ãŒã€è¡¨ç¤ºãŒä½“ç©(L)ã®å ´åˆ
                V_i_base = liquid.V_i / liquid.density;
            } else if (baseUnitType === 'volume' && isWeight) { // è¨ˆç®—åŸºæº–ãŒä½“ç©(L)ã ãŒã€è¡¨ç¤ºãŒé‡é‡(kg)ã®å ´åˆ
                V_i_base = liquid.V_i * liquid.density;
            }

            const V_i_final = V_i_base * (1 + lossRate) * factor;
            document.getElementById(`result_${liquid.id}`).textContent = `${V_i_final.toFixed(2)} ${unitLabel}`;
        });
        
        // åˆè¨ˆãƒ»å¸Œé‡ˆæ¶²ã®è¡¨ç¤º
        let V_mix_base = V_mix;
        let V_thinner_base = V_thinner;
        let V_total_base = V_total;
        
        // **æ³¨æ„: æ··åˆæ¶²ã‚„å¸Œé‡ˆæ¶²å…¨ä½“ã®å¯†åº¦ã¯å¹³å‡å¯†åº¦è¨ˆç®—ãŒå¿…è¦ã ãŒã€ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã—ã€å˜ã«åŸºæº–å˜ä½ã§è¨ˆç®—çµæœã‚’è¡¨ç¤º**
        // ç›¸äº’å¤‰æ›ãŒå¿…è¦ãªå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œå¯†åº¦å…¥åŠ›ã€ã‚’ä¿ƒã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å˜ç´”è¡¨ç¤ºã€‚

        const V_mix_final = V_mix_base * (1 + lossRate) * factor;
        const V_thinner_final = V_thinner_base * (1 + lossRate) * factor;
        const V_total_final = V_total_base * (1 + lossRate) * factor;

        document.getElementById('result_V_mix').textContent = `${V_mix_final.toFixed(2)} ${unitLabel}`;
        document.getElementById('result_V_thinner').textContent = `${V_thinner_final.toFixed(2)} ${unitLabel}`;
        document.getElementById('result_V_total').textContent = `${V_total_final.toFixed(2)} ${unitLabel}`;
        document.getElementById('result_A').textContent = `${A_calculated.toFixed(2)} mÂ²`;

        updateBaseValueInput(); // å˜ä½ã®å†è¡¨ç¤º
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>